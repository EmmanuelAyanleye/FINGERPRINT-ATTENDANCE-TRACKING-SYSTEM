{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fingerprint Verification</title>
    <link rel="stylesheet" href="{% static 'css/mark.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <script defer src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
</head>
<body>
    <div class="mx-auto rounded text-light p-4">
        <div class="head-details text-primary">
            <img src="{% static 'images/Espam logo.png' %}" alt="">
            <div class="head-title">
                <h4>Espam-Formation University</h4>
                <p>Student Attendance Management System</p>
            </div>
        </div>

        <div class="h5 text-center">Fingerprint Verification Page</div>
        <hr>

        <p class="h5 text-light text-center">Student Details</p>

        <div class="row" id="student-details">
            <div class="input-group mb-2">
                <span class="input-group-text bg-primary border-primary text-light">Student Name:</span>
                <input id="student-name" type="text" class="form-control" disabled>
            </div>
            <div class="input-group mb-2">
                <span class="input-group-text bg-primary border-primary text-light">Department:</span>
                <input id="student-department" type="text" class="form-control" disabled>
            </div>
            <div class="input-group mb-2">
                <span class="input-group-text bg-primary border-primary text-light">Matric No:</span>
                <input id="student-matric" type="text" class="form-control" disabled>
            </div>
            <div class="input-group mb-2">
                <span class="input-group-text bg-primary border-primary text-light">Level:</span>
                <input id="student-level" type="text" class="form-control" disabled>
            </div>
            <div class="input-group mb-2">
                <span class="input-group-text bg-primary border-primary text-light">Gender:</span>
                <input id="student-gender" type="text" class="form-control" disabled>
            </div>
        </div>

        <button id="scan-button" class="btn btn-secondary w-100 mt-2">Scan Fingerprint</button>
        <input type="hidden" id="fingerprint1" name="fingerprint1">
        <button id="done-button" class="btn btn-primary w-100 mt-2">Done</button>
    </div>

    <script>
        function getCsrfToken() {
            let cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                let [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') return value;
            }
            return '';
        }
    
        document.getElementById("scan-button").addEventListener("click", function() {
            this.disabled = true;
            this.innerHTML = "Scanning...";
    
            fetch("/api/start-fingerprint/", { 
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCsrfToken() // Added CSRF token
                },
                body: JSON.stringify({ student_id: "12345", operation_mode: "verify" }) // Replace with actual ID
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    document.getElementById("fingerprint1").value = data.fingerprint;
    
                    // Now verify fingerprint against database
                    return fetch("/api/verify_fingerprint/", {  // Fixed endpoint
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCsrfToken()  // CSRF token for security
                        },
                        body: JSON.stringify({ 
                            fingerprint: data.fingerprint, 
                            student_id: "12345"  // Ensure student ID is passed
                        })
                    });
                } else {
                    throw new Error("Fingerprint scanning failed.");
                }
            })
            .then(response => response.json())
            .then(studentData => {
                if (studentData.status === "success") {
                    document.getElementById("student-name").value = studentData.name;
                    document.getElementById("student-department").value = studentData.department;
                    document.getElementById("student-matric").value = studentData.matric_number;
                    document.getElementById("student-level").value = studentData.level;
                    document.getElementById("student-gender").value = studentData.gender;
                    alert("Student found: " + studentData.name);
                } else {
                    alert("Fingerprint not recognized.");
                }
            })

            .catch(error => alert(error.message))
            .finally(() => {
                this.disabled = false;
                this.innerHTML = "Scan Fingerprint";
            });
        });
    </script>
    
</body>
</html>